<!--
    Copyright (c) 2014 .. 2019, Maxwell Hadley
    All rights reserved.

    Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following
    conditions are met:

    1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following
    disclaimer.

    2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following
    disclaimer in the documentation and/or other materials provided with the distribution.

    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR
    IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
    FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR
    CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
    DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
    DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
    CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE
    USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
-->

<!-- This is the config node for the RFXtrx433 attached to a particular (pseudo) serial port -->
<script type="text/x-red" data-template-name="rfxtrx-port">
    <div class="form-row">
        <label for="node-config-input-port"><i class="fa fa-usb"></i> Serial Port</label>
        <input type="text" id="node-config-input-port" placeholder="/dev/ttyUSB0" style="width:61.3%;">
    </div>
    <div class="form-row">
        <label for="node-config-input-enableDebug">&nbsp;</label>
        <input type="checkbox" id="node-config-input-enableDebug" style="display:inline-block; width:15px; vertical-align:baseline;">
        <span>Show debug messages on the console</span>
    </div>
    <div class="form-row">
        <label for="node-config-input-rfyVenetianMode" style="width:65% !important">
              <i class="fa fa-cog"></i> Somfy/RFY venetian blinds command mode</label>
        <select id="node-config-input-rfyVenetianMode" style="width:18% !important">
          <option value="EU">EU</option>
          <option value="US">US</option>
        </select>
    </div>
</script>

<script type="text/x-red" data-help-name="rfxtrx-port">
<p>
Enter the serial port device name where the RFXtrx433 transceiver is located.
</p>
<p>
Enable the 'Show debug' option to log all serial communication with this RFXtrx433 transceiver to the console.
</p>
<p>
Select the Somfy venetian blind command mode to be used by all rfx-blinds-out nodes using this transceiver.
</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('rfxtrx-port', {
        category: 'config',
        defaults: {
            port: { value: "", required: true },
            enableDebug: {value: false, required: true },
            rfyVenetianMode: {value: "EU", required: true}
        },
        label: function () {
            return this.port;
        }
    });
</script>

<!-- This is a receiver node for listening to messages from lighting remote controls -->
<script type="text/x-red" data-template-name="rfx-lights-in">
    <div class="form-row node-input-port">
        <label for="node-input-port"><i class="fa fa-usb"></i> Serial Port</label>
        <input type="text" id="node-input-port">
    </div>
    <div class="form-row node-input-topic">
        <label for="node-input-topicSource"><i class="fa fa-envelope-o"></i> Address</label>
        <select id="node-input-topicSource" style="width:73% !important">
          <option value="all">listen for commands sent to any address</option>
          <option value="single">only listen for addresses matching a pattern</option>
        </select>
    </div>
    <div class="form-row" id="node-input-row-topic">
        <label for="node-input-topic"></label>
        <input type="text" id="node-input-topic" placeholder="protocol/device address">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<!-- Help text for rfx-lights-in -->
<script type="text/x-red" data-help-name="rfx-lights-in">
<p>
Listens for commands from lighting remote control transmitters using an RFXtrx433 transceiver
</p>
<p>The output message topic is the 'address' of the device being controlled; its payload is the command (a string).
The message also has a status property indicating the received the signal strength (rssi).
</p>
<p>
Addresses take the form '<b>type</b>/<b>device address</b>/<b>unit address</b>', where <b>type</b> is the name of the family
of devices (see RFXCOM documentation), <b>device address</b> is the address of the remote device, and <b>unit address</b> is the unit or
channel number of the addressed device. Channel 0 or '+' is used for group switching (or the equivalent) where supported.
</p>
<p>
For example 'BLYSS/0x0123/K/4' is a Blyss switched light paired with remote 0x0123, with groupcode 'K' and unit number 4.
</p>
<p>
The node can either receive all commands sent to any address, or only commands sent to a restricted subset of adresses
matching a topic template. For example, the address above would be matched by 'BLYSS', 'BLYSS/0x0123', 'BLYSS/0x0123/K',
'BLYSS/0x0123/K/4', or 'BLYSS/0x0123/K/+' (where the '+' character matches any unit number)
</p>
<p>
Typical commands are 'On' & 'Off' (or equivalently 1 & 0); 'Bright' or 'Dim+' to increase brightness; 'Dim' or 'Dim-' to
reduce brightness, or 'level <i>number</i>' (where <i>number</i> is a value between 0 and 1) to set the brightness to a given level.
</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('rfx-lights-in', {
        category: 'home automation',
        defaults: {
            name: {name:""},
            port: {type:"rfxtrx-port", required:true},
            topicSource: { value:"all", required:true },
            topic: { value:"", validate:function (t) {
                    return this.topicSource == "all" || t.length > 0
                }
            }
        },
        color:"BurlyWood",
        inputs:0,
        outputs:1,
        icon: "rfxcom.png",
        label: function () {
            var rfxtrxNode = RED.nodes.node(this.rfxtrx);
            return this.name || (rfxtrxNode ? rfxtrxNode.label() : "rfx-lights");
        },
        labelStyle: function () {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function () {
            var topicSource = $("#node-input-topicSource");
            topicSource.change(function () {
                var id = topicSource.find("option:selected").val();
                if (id == "single") {
                    $("#node-input-row-topic").show();
                } else {
                    $("#node-input-row-topic").hide();
                }
            });
            topicSource.val(this.topicSource);
            topicSource.change();
        }
    });
</script>

<!-- This is a transmitter node for lighting-type commands and the devices that receive them -->
<script type="text/x-red" data-template-name="rfx-lights-out">
    <div class="form-row node-input-port">
        <label for="node-input-port"><i class="fa fa-usb"></i> Serial Port</label>
        <input type="text" id="node-input-port">
    </div>
    <div class="form-row node-input-topic">
        <label for="node-input-topicSource"><i class="fa fa-envelope-o"></i> Address</label>
        <select id="node-input-topicSource" style="width:73% !important">
          <option value="msg">get address from message topic</option>
          <option value="node">send all commands to the same address</option>
        </select>
    </div>
    <div class="form-row" id="node-input-row-topic">
        <label for="node-input-topic"></label>
        <input type="text" id="node-input-topic" placeholder="protocol/device address/unit address">
    </div>
    <div class="form-row node-input-retransmit">
        <label for="node-input-retransmit"><i class="fa fa-refresh"></i> Repeat</label>
        <select id="node-input-retransmit" style="width:73% !important">
          <option value="none">send each command once only</option>
          <option value="once">repeat each command after a delay</option>
          <option value="repeat">repeat each command at regular intervals</option>
        </select>
    </div>
    <div class="form-row" id="node-input-row-retransmitInterval">
        <label for="node-input-retransmitInterval"></label>
        <span id="node-input-retransmitInterval-caption" style="width:10%; display:inline-block; margin-left: 8px; margin-right:12px;">Delay</span>
        <input type="text" id="node-input-retransmitInterval" style="width:10%" placeholder="10">
        <span id="node-input-retransmitInterval-units" style="display:inline-block; margin-left:6px;">seconds</span>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<!-- Help text for rfx-lights-out -->
<script type="text/x-red" data-help-name="rfx-lights-out">
<p>
Sends commands to remote lighting control devices using an RFXtrx433 transceiver
</p>
<p>The input message topic is the device 'address'. The input message payload is the command. Alternatively, the
same device address can be used for all messages.
</p>
<p>
Addresses take the form '<b>type</b>/<b>device address</b>/<b>unit address</b>', where <b>type</b> is the name of the
family of devices (see RFXCOM documentation), <b>device address</b> is the address of the remote device, and <b>unit
address</b> is the unit or channel number of the addressed device. Channel 0 or '+' is used for group switching (or the
equivalent) where supported.
</p>
<p>
For example 'AC/0x1ef1ce/4' is a HomeEasy switched socket paired with address 0x1ef1ce on channel 4, and 'X10/D/1' is
an X10 light switch with house code D and unit code 1.
</p>
<p>
Typical commands are 'On' & 'Off' (or equivalently 1 & 0, or <b>true</b> & <b>false</b>); 'Bright' or 'Dim+' to increase
brightness; 'Dim' or 'Dim-' to reduce brightness; 'level <i>percentage</i>%' or 'level <i>number</i>' (where <i>number</i>
is a value between 0 and 1) to set the brightness. Not all devices support all commands. Less common commands include
'Toggle' and 'Mood <i>number</i>'. Command messages from an alexa home node are also accepted.
</p>
<p>
To improve reliability, each message may be retransmitted, either once or at regular intervals. Only the most
recent message to each specific device address is repeated: the next message sent there will cancel any pending repeats.
<p>Supported device types are:
<ul>
<li>
AC
</li>
<li>
ANSLUT
</li>
<li>
AOKE
</li>
<li>
ARC
</li>
<li>
AVANTEK
</li>
<li>
BBSB
</li>
<li>
BLYSS
</li>
<li>
CASAFAN
</li>
<li>
CHACON
</li>
<li>
COCO
</li>
<li>
CONRAD
</li>
<li>
CUVEO
</li>
<li>
ELRO
</li>
<li>
EMW100
</li>
<li>
ENERGENIE_5_GANG
</li>
<li>
ENERGENIE_ENER010
</li>
<li>
EURODOMEST
</li>
<li>
FALMEC
</li>
<li>
FT1211R
</li>
<li>
HOMEEASY_EU
</li>
<li>
HQ
</li>
<li>
HUNTER_FAN
</li>
<li>
IMPULS
</li>
<li>
IT
</li>
<li>
KAMBROOK
</li>
<li>
KANGTAI
</li>
<li>
KOPPLA
</li>
<li>
LEGRAND
</li>
<li>
LIGHTWAVERF
</li>
<li>
LIVOLO
</li>
<li>
LIVOLO_APPLIANCE
</li>
<li>
LUCCI_AIR
</li>
<li>
LUCCI_AIR_DC
</li>
<li>
LUCCI_AIR_DCII
</li>
<li>
MDREMOTE
</li>
<li>
MDREMOTE_107
</li>
<li>
MDREMOTE_108
</li>
<li>
NOVY
</li>
<li>
OASE_FM
</li>
<li>
PHILIPS_SBC
</li>
<li>
RGB432W
</li>
<li>
RISING_SUN
</li>
<li>
SIEMENS_SF01
</li>
<li>
TEL_010
</li>
<li>
TRC02
</li>
<li>
TRC02_2
</li>
<li>
WAVEMAN
</li>
<li>
WESTINGHOUSE_7226640
</li>
<li>
X10
</li>
<li>
X10_SECURITY
</li>

</ul>
</script>

<script type="text/javascript">
    RED.nodes.registerType('rfx-lights-out', {
        category: 'home automation',
        defaults: {
            name: {name:""},
            port: {type:"rfxtrx-port", required:true},
            topicSource:{value:"msg", required:true},
            retransmit:{value: "none"},
            retransmitInterval:{value: 20,
                validate:function (i) {return i >= 10}
            },
            topic:{value:"",
                validate:function (t) {return this.topicSource == "msg" || t.length > 0}
            }
        },
        color:"BurlyWood",
        inputs:1,
        outputs:0,
        icon: "rfxcom.png",
        align: "right",
        label: function() {
            var rfxtrxNode = RED.nodes.node(this.rfxtrx);
            return this.name || (rfxtrxNode ? rfxtrxNode.label() : "rfx-lights");
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            var topicSource = $("#node-input-topicSource"),
                retransmit = $("#node-input-retransmit");
            retransmit.change(function () {
                var mode = retransmit.find("option:selected").val();
                if (mode === "none") {
                    $("#node-input-row-retransmitInterval").hide();
                } else {
                    if (mode === "once") {
                        $("#node-input-retransmitInterval-caption").text("Delay");
                        $("#node-input-retransmitInterval-units").text("seconds");
                    } else {
                        $("#node-input-retransmitInterval-caption").text("Interval");
                        $("#node-input-retransmitInterval-units").text("minutes");
                    }
                    $("#node-input-row-retransmitInterval").show();
                }
            });
            retransmit.val(this.retransmit);
            retransmit.change();
            topicSource.change(function () {
                var id = topicSource.find("option:selected").val();
                if (id == "node") {
                    $("#node-input-row-topic").show();
                } else {
                    $("#node-input-row-topic").hide();
                }
            });
            topicSource.val(this.topicSource);
            topicSource.change();
        }
    });
</script>

<!-- This is a transmitter node for fans -->
<script type="text/x-red" data-template-name="rfx-fan-out">
    <div class="form-row node-input-port">
        <label for="node-input-port"><i class="fa fa-usb"></i> Serial Port</label>
        <input type="text" id="node-input-port">
    </div>
    <div class="form-row node-input-topic">
        <label for="node-input-topicSource"><i class="fa fa-envelope-o"></i> Address</label>
        <select id="node-input-topicSource" style="width:73% !important">
          <option value="msg">get address from message topic</option>
          <option value="node">send all commands to the same address</option>
        </select>
    </div>
    <div class="form-row" id="node-input-row-topic">
        <label for="node-input-topic"></label>
        <input type="text" id="node-input-topic" placeholder="protocol/device address/unit address">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<!-- Help text for rfx-fan-out -->
<script type="text/x-red" data-help-name="rfx-fan-out">
<p>
Sends commands to fans & ventilators using an RFXtrx433 transceiver
</p>
<p>The input message topic is the device 'address'. The input message payload is the command. Alternatively, the
same device address can be used for all messages.
</p>
<p>
Addresses take the form '<b>type</b>/<b>device address</b>', where <b>type</b> is the name of the
family of devices and <b>device address</b> is the address of the remote device.
For example 'NOVY/0x3' is a Novy cooker hood paired with remote address 0x3.
</p>
<p>
Supported commands vary (a lot) between different devices. In most cases the speed may be changed, either directly
by commands like <b>slow</b>, <b>medium</b>, or <b>fast</b>; or by using a numeric value, like <b>speed 2</b>. Most devices
understand <b>start</b> & <b>stop</b>, but in some cases there is just one command which alternately starts & stops the fan:
use <b>power</b> for these. A few fans allow change of direction: either using a pair of commands like <b>normal</b> &
<b>reverse</b>, or just a single <b>reverse</b> command which alternates between the two.
</p>
<p>
A fan's built-in timer can be started by a <b>timer</b> command, with an optional numeric parameter. This is interpreted
differently by different fans, and may be ignored entirely.
</p>
<p>
Where a fan has a built-in light, this may be controlled using an <i>rfx-lights-out</i> node in the same way as any other
lighting device (using the same device address for both fan & light nodes). Programmable devices may be put into their
'learn' mode using a <b>program</b> command.
</p>
Supported device types are:
<ul>
<li>CASAFAN</li><li>FALMEC</li><li>FT1211R</li><li>HUNTER_FAN</li><li>ITHO_CVE_RFT</li><li>ITHO_CVE_ECO_RFT</li>
<li>LUCCI_AIR</li><li>LUCCI_AIR_DC</li><li>LUCCI_AIR_DCII</li><li>NOVY</li><li>SIEMENS_SF01</li><li>WESTINGHOUSE_7226640</li>
</ul>
</script>

<script type="text/javascript">
    RED.nodes.registerType('rfx-fan-out', {
        category: 'home automation',
        defaults: {
            name: {name:""},
            port: {type:"rfxtrx-port", required:true},
            topicSource: { value:"msg", required:true },
            topic: { value:"", validate:function (t) {
                    return this.topicSource == "msg" || t.length > 0
                }
            }
        },
        color:"BurlyWood",
        inputs:1,
        outputs:0,
        icon: "rfxcom.png",
        align: "right",
        label: function() {
            var rfxtrxNode = RED.nodes.node(this.rfxtrx);
            return this.name || (rfxtrxNode ? rfxtrxNode.label() : "rfx-fan");
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            var topicSource = $("#node-input-topicSource");
            topicSource.change(function() {
                var id = topicSource.find("option:selected").val();
                if (id == "node") {
                    $("#node-input-row-topic").show();
                } else {
                    $("#node-input-row-topic").hide();
                }
            });
            topicSource.val(this.topicSource);
            topicSource.change();
        }
    });
</script>

<!-- This is a receiver node for listening to messages from blinds remote controls -->
<script type="text/x-red" data-template-name="rfx-blinds-in">
    <div class="form-row node-input-port">
        <label for="node-input-port"><i class="fa fa-usb"></i> Serial Port</label>
        <input type="text" id="node-input-port">
    </div>
    <div class="form-row node-input-topic">
        <label for="node-input-topicSource"><i class="fa fa-envelope-o"></i> Address</label>
        <select id="node-input-topicSource" style="width:73% !important">
          <option value="all">listen for commands sent to any address</option>
          <option value="single">only listen for addresses matching a pattern</option>
        </select>
    </div>
    <div class="form-row" id="node-input-row-topic">
        <label for="node-input-topic"></label>
        <input type="text" id="node-input-topic" placeholder="protocol/device address">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<!-- Help text for rfx-blinds-in -->
<script type="text/x-red" data-help-name="rfx-blinds-in">
<p>
Listens for commands from blinds, curtains, and awnings remote control transmitters using an RFXtrx433 transceiver
</p>
<p>The output message topic is the 'address' of the device being controlled; its payload is the command (a string).
The message also has a status property indicating the received the signal strength (rssi).
</p>
<p>
Addresses take the form '<b>type</b>/<b>device address</b>/<b>unit address</b>', where <b>type</b> is the name of the family
of devices (see RFXCOM documentation), <b>device address</b> is the address of the remote device, and <b>unit address</b> is the unit or
channel number of the addressed device. Channel 0 or '+' is used for group switching (or the equivalent) where supported.
</p>
<p>
For example 'BLINDS_T1/0x0123/4' is a Hasta blinds remote, with ID 0x0123 and unit number 4.
</p>
<p>
The node can either receive all commands sent to any address, or only commands sent to a restricted subset of adresses
matching a topic template. For example, the address above would be matched by 'BLINDS_T1' or 'BLINDS_T1/0x0123'
</p>
<p>
The most common commands are 'Open', 'Close', and 'Stop'. Some types have a few others, including 'Confirm' used when
pairing a remote.
</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('rfx-blinds-in', {
        category: 'home automation',
        defaults: {
            name: {name:""},
            port: {type:"rfxtrx-port", required:true},
            topicSource: { value:"all", required:true },
            topic: { value:"", validate:function (t) {
                    return this.topicSource == "all" || t.length > 0
                }
            }
        },
        color:"BurlyWood",
        inputs:0,
        outputs:1,
        icon: "rfxcom.png",
        label: function () {
            var rfxtrxNode = RED.nodes.node(this.rfxtrx);
            return this.name || (rfxtrxNode ? rfxtrxNode.label() : "rfx-blinds");
        },
        labelStyle: function () {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function () {
            var topicSource = $("#node-input-topicSource");
            topicSource.change(function () {
                var id = topicSource.find("option:selected").val();
                if (id == "single") {
                    $("#node-input-row-topic").show();
                } else {
                    $("#node-input-row-topic").hide();
                }
            });
            topicSource.val(this.topicSource);
            topicSource.change();
        }
    });
</script>

<!-- This is a transmitter node for blinds & curtains -->
<script type="text/x-red" data-template-name="rfx-blinds-out">
    <div class="form-row node-input-port">
        <label for="node-input-port"><i class="fa fa-usb"></i> Serial Port</label>
        <input type="text" id="node-input-port">
    </div>
    <div class="form-row node-input-topic">
        <label for="node-input-topicSource"><i class="fa fa-envelope-o"></i> Address</label>
        <select id="node-input-topicSource" style="width:73% !important">
          <option value="msg">get address from message topic</option>
          <option value="node">send all commands to the same address</option>
        </select>
    </div>
    <div class="form-row" id="node-input-row-topic">
        <label for="node-input-topic"></label>
        <input type="text" id="node-input-topic" placeholder="protocol/device address/unit address">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<!-- Help text for rfx-blinds-out -->
<script type="text/x-red" data-help-name="rfx-blinds-out">
<p>
Sends commands to blind and curtain motors using an RFXtrx433 transceiver
</p>
<p>The input message topic is the motor 'address'. The input message payload is the command. Alternatively, the same
device address can be used for all messages.
</p>
<p>
Addresses take the form '<b>type</b>/<b>device address</b>/<b>unit address</b>', where <b>type</b> is the name of the
family of devices (see RFXCOM documentation), <b>device address</b> is the address of the remote device, and <b>unit
address</b> is the unit or channel number of the addressed device. Channel 0 or '+' is used for group control
(or the equivalent) where supported. Devices of families BLINDS_T2, BLINDS_T4, BLINDS_T5, BLINDS_T10 &amp;
BLINDS_T18 do not have unit addresses.
</p>
<p>
For example, 'HARRISON/A/3' is a curtain motor with house code A and unit address 3, and 'BLINDS_T5/0x123' is a Media
Mount projection screen with device address 0x123.
</p>
<p>
Curtain motors, BLINDS_Tx motors, and the LightWave RF relay accept commands "open", "close", &amp; "stop".
BLINDS_T5 motors (Media Mount projection screens) also accept "up" &amp; "down".
RFY/Somfy motors use "up" &amp; "down" for roller blinds, and "open" &amp; "close" for venetian blinds.
Venetian blind motors also accept "angle+" and "angle-" commands. Somfy awning motors
accept "auto" &amp; "manual" to control the sun/wind sensor.
</p>
<p>
A "list" command with a message topic of 'RFY' will show a list of all the Somfy/RFY remote ID's programmed into the
RFXtrx433E transceiver. Send a "program" command after 'arming' the Somfy blind motor using the Somfy remote controller,
to program an association between the ID from the message topic and the motor.
</p>
<p>
Somfy venetian blind motors come in EU and US variants: the command mode used is set from the Serial Port configuration
dialog, and applies to <i>all</i> motors used with the transceiver on that serial port.
</p>
Supported device types are:
<ul>
<li>ASA</li><li>BLINDS_T0 to BLINDS_T20</li><li>BREL_DOOYA</li><li>GEOM</li><li>HARRISON</li><li>LIGHTWAVERF</li><li>RFY</li><li>RFYEXT</li>
</ul>
</script>

<script type="text/javascript">
    RED.nodes.registerType('rfx-blinds-out', {
        category: 'home automation',
        defaults: {
            name: {name:""},
            port: {type:"rfxtrx-port", required:true},
            topicSource: { value:"msg", required:true },
            topic: { value:"", validate:function (t) {
                    return this.topicSource == "msg" || t.length > 0
                }
            },
//            rfyVenetianMode: {value: "EU", required: true}
        },
        color:"BurlyWood",
        inputs:1,
        outputs:0,
        icon: "rfxcom.png",
        align: "right",
        label: function() {
            var rfxtrxNode = RED.nodes.node(this.rfxtrx);
            return this.name || (rfxtrxNode ? rfxtrxNode.label() : "rfx-blinds");
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            var topicSource = $("#node-input-topicSource");
            topicSource.change(function() {
                var id = topicSource.find("option:selected").val();
                if (id == "node") {
                    $("#node-input-row-topic").show();
                } else {
                    $("#node-input-row-topic").hide();
                }
            });
            topicSource.val(this.topicSource);
            topicSource.change();
        }
    });
</script>

<!-- This is a receiver node for listening to messages from doorbells -->
<script type="text/x-red" data-template-name="rfx-doorbell-in">
    <div class="form-row node-input-port">
        <label for="node-input-port"><i class="fa fa-usb"></i> Serial Port</label>
        <input type="text" id="node-input-port">
    </div>
    <div class="form-row node-input-topic">
        <label for="node-input-topicSource"><i class="fa fa-envelope-o"></i> Address</label>
        <select id="node-input-topicSource" style="width:73% !important">
          <option value="all">listen for commands sent to any address</option>
          <option value="single">only listen for addresses matching a pattern</option>
        </select>
    </div>
    <div class="form-row" id="node-input-row-topic">
        <label for="node-input-topic"></label>
        <input type="text" id="node-input-topic" placeholder="protocol/device address">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<!-- Help text for rfx-doorbell-in -->
<script type="text/x-red" data-help-name="rfx-doorbell-in">
<p>
Listens for commands from wireless doorbell pushes using an RFXtrx433 transceiver</p>
<p>The output message topic is the 'address' of the bellpush; if a payload is present it is the tone number (0-15).
Only BYRON_SX type bellpushes send a tone number; messages from other types have no payload.
The message also has a status property indicating the received the signal strength (rssi).
</p>
<p>
Addresses take the form '<b>type</b>/<b>device address</b>', where <b>type</b> is the name of the family
of devices (see RFXCOM documentation) and <b>device address</b> is the address of the bellpush. For example
'BYRON_SX/0x12' is a Byron SX bellpush with device address 0x12. ARC family bellpush addresses
may also include a unit number, but this is ignored by ARC chimes.
</p><p>
The node can either receive messages from any address, or only from a restricted subset of adresses
matching a topic template. For example, the address above would be matched by 'BYRON_SX', or 'BYRON_SX/0x012'.
</p><p>Currently, BYRON_MP001 bellpushes cannot be received.</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('rfx-doorbell-in', {
        category: 'home automation',
        defaults: {
            name: {name:""},
            port: {type:"rfxtrx-port", required:true},
            topicSource: { value:"all", required:true },
            topic: { value:"", validate:function (t) {
                return this.topicSource == "all" || t.length > 0
            }
            }
        },
        color:"BurlyWood",
        inputs:0,
        outputs:1,
        icon: "rfxcom.png",
        label: function () {
            var rfxtrxNode = RED.nodes.node(this.rfxtrx);
            return this.name || (rfxtrxNode ? rfxtrxNode.label() : "rfx-doorbell");
        },
        labelStyle: function () {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function () {
            var topicSource = $("#node-input-topicSource");
            topicSource.change(function () {
                var id = topicSource.find("option:selected").val();
                if (id == "single") {
                    $("#node-input-row-topic").show();
                } else {
                    $("#node-input-row-topic").hide();
                }
            });
            topicSource.val(this.topicSource);
            topicSource.change();
        }
    });
</script>

<!-- This is a transmitter node for wireless doorbells -->
<script type="text/x-red" data-template-name="rfx-doorbell-out">
    <div class="form-row node-input-port">
        <label for="node-input-port"><i class="fa fa-usb"></i> Serial Port</label>
        <input type="text" id="node-input-port">
    </div>
    <div class="form-row node-input-topic">
        <label for="node-input-topicSource"><i class="fa fa-envelope-o"></i> Address</label>
        <select id="node-input-topicSource" style="width:73% !important">
          <option value="msg">get address from message topic</option>
          <option value="node">send all commands to the same address</option>
        </select>
    </div>
    <div class="form-row" id="node-input-row-topic">
        <label for="node-input-topic"></label>
        <input type="text" id="node-input-topic" placeholder="protocol/device address/unit address">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<!-- Help text for rfx-doorbell-out -->
<script type="text/x-red" data-help-name="rfx-doorbell-out">
<p>
Sends commands to wireless doorbell chimes using an RFXtrx433 transceiver
</p>
<p>The input message topic is the chime 'address'. Alternatively, the same device address can be used for all messages.
A message payload, if present, is ignored unless sending to a chime of type BYRON_SX, when it is the (optional)
tone number in the range 0 to 15.
</p>
<p>
Addresses take the form '<b>type</b>/<b>device address</b>', where <b>type</b> is the name of the family
of devices (see RFXCOM documentation), and <b>device address</b> is the address of the remote device. For all families
other than BYRON_MP001, the address is a hexadecimal number. For these devices, the address is a six-bit binary number
corresponding to the bellpush switches, where 1&nbsp;=&nbsp;switch on and 0&nbsp;=&nbsp;switch off.
</p>
Supported device types are:
<ul>
<li>ALFAWISE</li><li>ARC</li><li>BYRON_BY</li><li>BYRON_MP001</li><li>BYRON_SX</li><li>ENVIVO</li><li>SELECT_PLUS</li>
</ul>
</script>

<script type="text/javascript">
    RED.nodes.registerType('rfx-doorbell-out', {
        category: 'home automation',
        defaults: {
            name: {name:""},
            port: {type:"rfxtrx-port", required:true},
            topicSource: { value:"msg", required:true },
            topic: { value:"", validate:function (t) {
                    return this.topicSource == "msg" || t.length > 0
                }
            }
        },
        color:"BurlyWood",
        inputs:1,
        outputs:0,
        icon: "rfxcom.png",
        align: "right",
        label: function() {
            var rfxtrxNode = RED.nodes.node(this.rfxtrx);
            return this.name || (rfxtrxNode ? rfxtrxNode.label() : "rfx-doorbell");
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            var topicSource = $("#node-input-topicSource");
            topicSource.change(function() {
                var id = topicSource.find("option:selected").val();
                if (id == "node") {
                    $("#node-input-row-topic").show();
                } else {
                    $("#node-input-row-topic").hide();
                }
            });
            topicSource.val(this.topicSource);
            topicSource.change();
        }
    });
</script>

<!-- This is a receiver node for listening to messages from energy meters -->
<script type="text/x-red" data-template-name="rfx-meter">
    <div class="form-row node-input-port">
        <label for="node-input-port"><i class="fa fa-usb"></i> Serial Port</label>
        <input type="text" id="node-input-port">
    </div>
    <div class="form-row node-input-topic">
        <label for="node-input-topicSource"><i class="fa fa-envelope-o"></i> Address</label>
        <select id="node-input-topicSource" style="width:73% !important">
          <option value="all">listen for data messages from any address</option>
          <option value="single">only listen to addresses matching a pattern</option>
        </select>
    </div>
    <div class="form-row" id="node-input-row-topic">
        <label for="node-input-topic"></label>
        <input type="text" id="node-input-topic" placeholder="protocol/device address">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<!-- Help text for rfx-meter -->
<script type="text/x-red" data-help-name="rfx-meter">
<p>
Listens for measurement messages from energy and current meters using an RFXtrx433 transceiver
</p>
<p>The output message topic is the type and ID of the sensor. The output message payload is an object containing the
meter measurement types, values & units of measurement, with status information.
The message also has a status property indicating the received the signal strength (rssi), and the battery level if available.</p>
</p>
<p>
For example an Owl CM180 meter may generate a message with a topic 'CM180/0xA412' and a payload
<i>
{"power":{"value":370, "unit":"W"}, "energy":{"value":30226.3151306, "unit":"Wh"}}</i>.
</p>
<p>
The node can either receive measurement messages from any address, or only from a restricted subset of adresses
matching a topic template. For example, 'REVOLT' would receive messages only from Revolt energy meters,
and 'CM180/0xA412' would receive only messages from the sensor described above.
</p>
<p>
Depending on the meter type, the available data may include current, voltage, power, energy (total energy used),
power factor, and frequency. For meters with multiple current sensing channels, the current.value property
is an array
</p>
<p>
Data from Linky smartmeters, and the older types using TIC  can be received using the Cartelectronic transmitter.
</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('rfx-meter', {
        category: 'home automation',
        defaults: {
            name: {name:""},
            port: {type:"rfxtrx-port", required:true},
            topicSource: { value:"all", required:true },
            topic: { value:"", validate:function(t) {
                    return this.topicSource == "all" || t.length > 0
                }
            }
        },
        color:"BurlyWood",
        inputs:0,
        outputs:1,
        icon: "rfxcom.png",
        label: function() {
            var rfxtrxNode = RED.nodes.node(this.rfxtrx);
            return this.name || (rfxtrxNode ? rfxtrxNode.label() : "rfx-meter");
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            var topicSource = $("#node-input-topicSource");
            topicSource.change(function() {
                var id = topicSource.find("option:selected").val();
                if (id == "single") {
                    $("#node-input-row-topic").show();
                } else {
                    $("#node-input-row-topic").hide();
                }
            });
            topicSource.val(this.topicSource);
            topicSource.change();
        }
    });
</script>

<!-- This is a receiver node for listening to messages from temperature & humidity sensors -->
<script type="text/x-red" data-template-name="rfx-sensor">
    <div class="form-row node-input-port">
        <label for="node-input-port"><i class="fa fa-usb"></i> Serial Port</label>
        <input type="text" id="node-input-port">
    </div>
    <div class="form-row node-input-topic">
        <label for="node-input-topicSource"><i class="fa fa-envelope-o"></i> Address</label>
        <select id="node-input-topicSource" style="width:73% !important">
          <option value="all">listen for data messages from any address</option>
          <option value="single">only listen to addresses matching a pattern</option>
        </select>
    </div>
    <div class="form-row" id="node-input-row-topic">
        <label for="node-input-topic"></label>
        <input type="text" id="node-input-topic" placeholder="protocol/device address">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<!-- Help text for rfx-sensor -->
<script type="text/x-red" data-help-name="rfx-sensor">
<p>
Listens for measurement messages from thermometers and various types of weather sensor using an RFXtrx433 transceiver
</p>
<p>The output message topic is the type and ID of the sensor. The output message payload is an object containing the
sensor measurement types, values & units of measurement, with status information.
The message also has a status property indicating the received the signal strength (rssi), and the battery level if available.</p>
<p>
For example an Oregon THGN132 temperature & humidity sensor may generate a message with a topic 'TH1/0xE801' and a payload
<i>
{"temperature":{"value":15.1, "unit":"degC"}, "humidity":{"value":60, "unit":"%", "status":"NORMAL"}}</i>.
</p>
<p>
The node can either receive measurement messages from any address, or only from a restricted subset of adresses
matching a topic template. For example, 'TH4' would receive messages only from Oregon THGR328 temperature/humidity sensors,
and 'TH1/0xE801' would receive only messages from the sensor described above.
</p>
<p>
Depending on the sensor type, the available data may include temperature, humidity, barometric pressure, UV index, wind speed
& direction, and rainfall. For the Maverick ET-732 BBQ thermometer, <i>payload.temperature.value[0]</i> is the meat sensor &
<i>payload.temperature.value[1]</i> is the BBQ sensor.
</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('rfx-sensor', {
        category: 'home automation',
        defaults: {
            name: {name:""},
            port: {type:"rfxtrx-port", required:true},
            topicSource: { value:"all", required:true },
            topic: { value:"", validate:function(t) {
                    return this.topicSource == "all" || t.length > 0
                }
            }
        },
        color:"BurlyWood",
        inputs:0,
        outputs:1,
        icon: "rfxcom.png",
        label: function() {
            var rfxtrxNode = RED.nodes.node(this.rfxtrx);
            return this.name || (rfxtrxNode ? rfxtrxNode.label() : "rfx-sensor");
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            var topicSource = $("#node-input-topicSource");
            topicSource.change(function() {
                var id = topicSource.find("option:selected").val();
                if (id == "single") {
                    $("#node-input-row-topic").show();
                } else {
                    $("#node-input-row-topic").hide();
                }
            });
            topicSource.val(this.topicSource);
            topicSource.change();
        }
    });
</script>

<!-- This is a transmitter node for thermostatic radiator valves -->
<script type="text/x-red" data-template-name="rfx-trv-out">
    <div class="form-row node-input-port">
        <label for="node-input-port"><i class="fa fa-usb"></i> Serial Port</label>
        <input type="text" id="node-input-port">
    </div>
    <div class="form-row node-input-topic">
        <label for="node-input-topicSource"><i class="fa fa-envelope-o"></i> Address</label>
        <select id="node-input-topicSource" style="width:73% !important">
          <option value="msg">get address from message topic</option>
          <option value="node">send all commands to the same address</option>
        </select>
    </div>
    <div class="form-row" id="node-input-row-topic">
        <label for="node-input-topic"></label>
        <input type="text" id="node-input-topic" placeholder="protocol/device address/unit address">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<!-- Help text for rfx-trv-out -->
<script type="text/x-red" data-help-name="rfx-trv-out">
<p>
Sends commands to Smartwares wireless TRVs using an RFXtrx433 transceiver
</p>
<p>
A numeric message payload, or a string containing a number, controls the setpoint temperature. A payload of
"Day" or "Night" sets the normal/setback mode. Also understands Alexa Node-RED Home Skill commands to set the
temperature and switch "On" or "Off"
</p>
<p>The input message topic is the TRV 'address'. Alternatively, the same device address can be used for all messages.
Addresses take the form '<b>SMARTWARES</b>/<b>address</b>/<b>unit code</b>', where <b>device address</b> is the address
of the remote controller, 0x01 to 0x3ffffff, and <b>unit code</b> is the TRV channel number, 1 to 16.
</p>
Supported device types are:
<ul>
<li>SMARTWARES</li>
</ul>
</script>

<script type="text/javascript">
    RED.nodes.registerType('rfx-trv-out', {
        category: 'home automation',
        defaults: {
            name: {name:""},
            port: {type:"rfxtrx-port", required:true},
            topicSource: { value:"msg", required:true },
            topic: { value:"", validate:function (t) {
                    return this.topicSource == "msg" || t.length > 0
                }
            }
        },
        color:"BurlyWood",
        inputs:1,
        outputs:0,
        icon: "rfxcom.png",
        align: "right",
        label: function() {
            var rfxtrxNode = RED.nodes.node(this.rfxtrx);
            return this.name || (rfxtrxNode ? rfxtrxNode.label() : "rfx-trv");
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            var topicSource = $("#node-input-topicSource");
            topicSource.change(function() {
                var id = topicSource.find("option:selected").val();
                if (id == "node") {
                    $("#node-input-row-topic").show();
                } else {
                    $("#node-input-row-topic").hide();
                }
            });
            topicSource.val(this.topicSource);
            topicSource.change();
        }
    });
</script>

<!-- This is a transmitter node for boiler controls and heaters -->
<script type="text/x-red" data-template-name="rfx-heat-out">
    <div class="form-row node-input-port">
        <label for="node-input-port"><i class="fa fa-usb"></i> Serial Port</label>
        <input type="text" id="node-input-port">
    </div>
    <div class="form-row node-input-topic">
        <label for="node-input-topicSource"><i class="fa fa-envelope-o"></i> Address</label>
        <select id="node-input-topicSource" style="width:73% !important">
          <option value="msg">get address from message topic</option>
          <option value="node">send all commands to the same address</option>
        </select>
    </div>
    <div class="form-row" id="node-input-row-topic">
        <label for="node-input-topic"></label>
        <input type="text" id="node-input-topic" placeholder="protocol/device address/unit address">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<!-- Help text for rfx-heat-out -->
<script type="text/x-red" data-help-name="rfx-heat-out">
<p>
Sends commands to stoves, boiler controls, and other heaters using an RFXtrx433 transceiver
</p>
<p>The input message topic is the device 'address'. The input message payload is the command. Alternatively, the
same device address can be used for all messages.
</p>
<p>
Addresses take the form '<b>type</b>/<b>device address</b>', where <b>type</b> is the name of the
family of devices (see RFXCOM documentation), and <b>device address</b> is the address of the remote device.
For example 'G6R_H4T1/0xce' is a Mertix/Maxitrol gas fire with address 0xce, and 'HE105/0x03' is
a HomeEasy boiler control relay with its address switches set to 0 0 0 1 1.
</p>
<p>
Commands vary depending on device type. All support 'On' & 'Off' (or equivalently <b>true</b> & <b>false</b>). Digimax
thermostat receivers also support 'heat' & 'cool'. Numbers are interpreted either as On or Off (0 or >0), or as the flame
power setting in the range 1 to 5 for MCZ pellet stoves. A string containing a number is interpreted in the same way,
unless it is a percentage - e.g. "40%" means flame power 2. A string containing "+" or "-" (or "up" & "down")
tells a Maxitrol fire to increase or decrease the flame setting. Use "On 2"/"Off 2" to control the second burner on
a Maxitrol G6R-H4TB, and "Run up"/"Run down"/"Stop" to control the modulating burner on G6R-H4T1 stoves.
</p>
<p>
MCZ pellet stoves and Digimax thermostat receivers also accept object message payloads. For Digimax, the only object
parameter required is 'status' - 1 means demand is required (heating or cooling), 2 means no demand. The rfx-sensor node
will receive Digimax thermostat units and generate messages containing objects compatible with this format.
</p>
<p>
The MCZ object format parameters are:
</p>
<table>
<tr><td><b>fanSpeed</b></td><td>a single number applies to all fans, or an array. Values are 0 to 5, or 6 for 'auto'</td></tr>
<tr><td><b>mode</b></td><td>"Off", "Man", "Auto", or "Eco"</td></tr>
<tr><td><b>beep</b></td><td>true or false</td></tr>
<tr><td><b>flamePower</b></td><td>1 to 5</td></tr>
</table>
<p>
If any fan speed is 0, flamePower must be 1. The flamePower parameter is mandatory unless mode is "Off" - the others
are optional. Fan speeds default to 'auto' (6).
</p>
<p>
Appropriate Alexa Node-RED Home Skill command messages are also accepted by all device types.
</p>
Supported device types are:
<ul>
<li>DIGIMAX_SHORT</li><li>DIGIMAX_TLX7506</li><li>G6R_H3T1</li><li>G6R_H4S</li><li>G6R_H4T1</li><li>G6R_H4TB</li><li>G6R_H4TD</li>
<li>HE105</li><li>MCZ_PELLET_STOVE_1_FAN</li><li>MCZ_PELLET_STOVE_2_FAN</li><li>MCZ_PELLET_STOVE_3_FAN</li><li>RTS10_RFS10_TLX1206</li>
</ul>
</script>

<script type="text/javascript">
    RED.nodes.registerType('rfx-heat-out', {
        category: 'home automation',
        defaults: {
            name: {name:""},
            port: {type:"rfxtrx-port", required:true},
            topicSource: { value:"msg", required:true },
            topic: { value:"", validate:function (t) {
                    return this.topicSource == "msg" || t.length > 0
                }
            }
        },
        color:"BurlyWood",
        inputs:1,
        outputs:0,
        icon: "rfxcom.png",
        align: "right",
        label: function() {
            var rfxtrxNode = RED.nodes.node(this.rfxtrx);
            return this.name || (rfxtrxNode ? rfxtrxNode.label() : "rfx-heat");
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            var topicSource = $("#node-input-topicSource");
            topicSource.change(function() {
                var id = topicSource.find("option:selected").val();
                if (id == "node") {
                    $("#node-input-row-topic").show();
                } else {
                    $("#node-input-row-topic").hide();
                }
            });
            topicSource.val(this.topicSource);
            topicSource.change();
        }
    });
</script>

<!-- This is a receiver node for listening to messages from intruder and smoke detectors -->
<script type="text/x-red" data-template-name="rfx-detector-in">
    <div class="form-row node-input-port">
        <label for="node-input-port"><i class="fa fa-usb"></i> Serial Port</label>
        <input type="text" id="node-input-port">
    </div>
    <div class="form-row node-input-topic">
        <label for="node-input-topicSource"><i class="fa fa-envelope-o"></i> Address</label>
        <select id="node-input-topicSource" style="width:73% !important">
          <option value="all">listen for data messages from any address</option>
          <option value="single">only listen to addresses matching a pattern</option>
        </select>
    </div>
    <div class="form-row" id="node-input-row-topic">
        <label for="node-input-topic"></label>
        <input type="text" id="node-input-topic" placeholder="protocol/device address">
    </div>
    <div class="form-row">
        <label for="node-input-outputHeartbeats">&nbsp;</label>
        <input type="checkbox" id="node-input-outputHeartbeats" style="display:inline-block; width:15px; vertical-align:baseline;">
        <span>Output detector heartbeat messages</span>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<!-- Help text for rfx-detector -->
<script type="text/x-red" data-help-name="rfx-detector-in">
<p>
Listens for messages from wireless intruder and smoke detectors using an RFXtrx433 transceiver
</p>
<p>The output message topic is the type and ID of the detector. The message payload depends on the detector type:
</p>
<ul>
<li>Smoke detectors will send a "Smoke" payload when triggered.</li>
<li>PIR motion detectors will send a "Motion" payload when triggered.</li>
<li>Door/window opening detectors will send an "Alarm" payload when triggered, and a "Normal" payload
when the door or window is closed again.</li>
<li>Suitably equipped detectors will send a "Tamper" payload when the anti-tamper circuit is triggered.</li>
<li>X10 and some types of Visonic PowerCode detectors report their status at regular intervals. Optionally, these
reports may be sent to the node output - if everything is normal the output message payload will be "Heartbeat". However,
the node will always send an output message with a payload of "Battery Low" if the detector reports low battery in a
status message.
<br>
Whether or not heartbeat output is enabled, if the status reports stop, the node will send an output message with
a "Silent" payload. These repeat at regular intervals until another transmission (of any type) is received
from the same device.
</li>
</ul>
<p>
The node can also receive the basic commands from X10 security remote controls: Arm (home/away, with or without delay) & Disarm, and
Panic & End Panic. (The light control commands are received by the <b>rfx-lights-in</b> node)
<p>
The node can either receive messages from any address, or only from a restricted subset of adresses
matching a topic template. For example, 'KD101' would receive messages only from Flamingo, Chacon, NEXA and similar
smoke detectors.
</p>
<p>
<b>This node and the associated software must not be used in situations where the avoidance of damage to
or loss of property, or protection from risk of injury or death, may depend on its correct operation.</b>
</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('rfx-detector-in', {
        category: 'home automation',
        defaults: {
            name: {name:""},
            port: {type:"rfxtrx-port", required:true},
            topicSource: { value:"all", required:true },
            topic: { value:"", validate:function(t) {
                    return this.topicSource == "all" || t.length > 0
                }
            },
            outputHeartbeats: {value: false, required:true}
        },
        color:"BurlyWood",
        inputs:0,
        outputs:1,
        icon: "rfxcom.png",
        label: function() {
            var rfxtrxNode = RED.nodes.node(this.rfxtrx);
            return this.name || (rfxtrxNode ? rfxtrxNode.label() : "rfx-detector");
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            var topicSource = $("#node-input-topicSource");
            topicSource.change(function() {
                var id = topicSource.find("option:selected").val();
                if (id == "single") {
                    $("#node-input-row-topic").show();
                } else {
                    $("#node-input-row-topic").hide();
                }
            });
            topicSource.val(this.topicSource);
            topicSource.change();
        }
    });
</script>

<!-- This is a transmitter node for wireless alarms -->
<script type="text/x-red" data-template-name="rfx-alarm-out">
    <div class="form-row node-input-port">
        <label for="node-input-port"><i class="fa fa-usb"></i> Serial Port</label>
        <input type="text" id="node-input-port">
    </div>
    <div class="form-row node-input-topic">
        <label for="node-input-topicSource"><i class="fa fa-envelope-o"></i> Address</label>
        <select id="node-input-topicSource" style="width:73% !important">
          <option value="msg">get address from message topic</option>
          <option value="node">send all commands to the same address</option>
        </select>
    </div>
    <div class="form-row" id="node-input-row-topic">
        <label for="node-input-topic"></label>
        <input type="text" id="node-input-topic" placeholder="protocol/device address/unit address">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<!-- Help text for rfx-alarm-out -->
<script type="text/x-red" data-help-name="rfx-alarm-out">
<p>
Sends control commands to X10 alarm systems and alarm signals to wireless smoke detectors using an RFXtrx433 transceiver
</p>
<p>
<p>The input message topic is the alarm 'address'.
Alternatively, the same device address can be used for all messages.
Addresses take the form '<b><i>device type</i></b>/<b>device address</b>', where <b>device address</b> is the address
of the alarm, 0x01 to either 0xffff or 0x3fffff, depending on the type of device.
</p>
<p>
The supported X10 alarm commands are <b>Panic</b> and <b>End Panic</b>, <b>Arm</b> (with options <b>Home</b> or <b>Away</b>,
and <b>Delayed</b>), and <b>Disarm</b>. To sound an alarm on an X10_SECURITY alarm system, use the payload <b>Panic</b>.
Other types of device ignore the message payload and will always sound an alarm when a message is received.
</p>
Supported device types are:
<ul>
<li>KD101</li><li>RM74RF</li><li>SA30</li><li>X10_SECURITY</li>
</ul>

</script>

<script type="text/javascript">
    RED.nodes.registerType('rfx-alarm-out', {
        category: 'home automation',
        defaults: {
            name: {name:""},
            port: {type:"rfxtrx-port", required:true},
            topicSource: { value:"msg", required:true },
            topic: { value:"", validate:function (t) {
                    return this.topicSource == "msg" || t.length > 0
                }
            }
        },
        color:"BurlyWood",
        inputs:1,
        outputs:0,
        icon: "rfxcom.png",
        align: "right",
        label: function() {
            var rfxtrxNode = RED.nodes.node(this.rfxtrx);
            return this.name || (rfxtrxNode ? rfxtrxNode.label() : "rfx-alarm");
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            var topicSource = $("#node-input-topicSource");
            topicSource.change(function() {
                var id = topicSource.find("option:selected").val();
                if (id == "node") {
                    $("#node-input-row-topic").show();
                } else {
                    $("#node-input-row-topic").hide();
                }
            });
            topicSource.val(this.topicSource);
            topicSource.change();
        }
    });
</script>

<!-- This is the config node holding deviceList data for PT2262 nodes -->
<script type="text/x-red" data-template-name="PT2262-device-list">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <div style="padding: 5px; padding-left: 0px; border: 1px solid #fff; margin-bottom:-12px">
            <span style="display:inline-block; margin-left:12px; width:40%;">Topic</span>
            <span style="display:inline-block; margin-left:12px; width:20%;">Payload</span>
            <span style="display:inline-block; margin-left:12px; width:12%; text-align:right;">Data</span>
            <span style="display:inline-block; margin-left:15px; width:8%; text-align:right;">Pulse</span>
        </div>
    </div>
    <div class="form-row">
        <div id="node-config-list-container-div" style="border-radius: 5px; height: 240px; padding: 5px; padding-left: 0px; border: 1px solid #ccc; overflow-y:scroll;">
            <ol id="node-config-list-container" style="list-style-type:none; margin: 0;">
            </ol>
        </div>
    </div>
    <div class="form-row">
        <button class="red-ui-button" id="node-config-add-list-entry" style="margin-top: 4px;"><i class="fa fa-plus"></i> Add New Device</button>
    </div>

</script>

<script type="text/x-red" data-help-name="PT2262-device-list">
<p>
The entries in a Device List match a user-defined message <i>Topic</i> and <i>Payload</i> to a hexadecimal <i>Data</i>
value, and a <i>Pulse</i> duration in microseconds:
<ul>
<li>
When an rfx-PT2262-out node receives a message, it scans the list
looking for an entry with matching <i>Topic</i> and <i>Payload</i>. If it finds one, it tells the RFXtrx433 to send
a radio transmission with the corresponding <i>Data</i> value, using the corresponding <i>Pulse</i> duration.
</li>
<li>
When an rfx-PT2262-in node receives a radio transmission from the RFXtrx433, it scans the list looking for a matching
<i>Data</i> value. If it finds one, it sends a message with the corresponding <i>Topic</i> and <i>Payload</i> (the
<i>Pulse</i> value is ignored)
</li>
</ul>
</p>
<p>
Within a device list, the <i>Topic</i> and <i>Payload</i> may be assigned arbitrarily, but the combination of the two
must be unique (duplicates are deleted when you <b>Update</b> the list). Although the actual text of each is arbitrary,
you should keep to the /-delimited format for the <i>Topic</i>, and it is a good idea to always start with 'PT2262/'.
</p>
<p>
You can add as many entries as you want with the <b>Add New Device</b> button, or delete existing entries with the <b>x</b>
button on each row. The same list may be shared by multiple rfx-PT2262-in and
rfx-PT2262-out nodes, or different nodes may use different lists.
</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('PT2262-device-list', {
        category: 'config',
        defaults: {
            name: { value:"", required:true },
            devices: { value:[], required: true }
        },
        label: function () {
            return this.name || 'PT2262 devices';
        },
        oneditprepare: function () {
            function generateEntry(entry, insert) {
                var container = $('<li/>', {style:"margin:0; padding:4px; padding-left:2px; padding-top:2px;"});
                var row = $('<div/>').appendTo(container);
                var entryField = $('<span/>').appendTo(row);
                var deviceField = $('<input/>', { class:"node-config-device-input-value", type:"text",
                    style:"margin-left:2px; margin-right:2px; width:42%;"}).appendTo(entryField);
                var payloadField = $('<input/>', { class:"node-config-payload-input-value", type:"text",
                    style:"margin-left:2px; margin-right:2px; width:28%;"}).appendTo(entryField);
                var rawDataField = $('<input/>', { class:"node-config-rawdata-input-value", type:"text",
                    style:"margin-left:2px; margin-right:2px; width:12%; text-align:right;"}).appendTo(entryField);
                var pulseWidthField = $('<input/>', { class:"node-config-pulsewidth-input-value", type:"text",
                    style:"margin-left:2px; margin-right:2px; width:8%; text-align:right;"}).appendTo(entryField);
                var deleteButton = $('<button>', {type:"button", class:"red-ui-button", style:"margin-left: 5px;"}).appendTo(row);
                    $('<i/>', {class:"fa fa-trash"}).appendTo(deleteButton);
                    deleteButton.click(function() {
                        container.css({"background":"#fee"});
                        container.fadeOut(300, function() {
                            $(this).remove();
                        });
                    });
                    deviceField.val(entry.device.join("/"));
                    payloadField.val(entry.payload);
                    rawDataField.val(entry.rawData);
                    pulseWidthField.val(entry.pulseWidth);
                    $("#node-config-list-container").append(container);
                }

                $("#node-config-add-list-entry").click(function () {
                    generateEntry({ device:["PT2262"], payload:"", rawData:0, pulseWidth:350 });
                    $("#node-config-list-container-div").scrollTop($("#node-config-list-container-div").get(0).scrollHeight);
                });

                if ( this.devices !== undefined ) {
                    for (var i = 0; i < this.devices.length; i++) {
                        var entry = this.devices[i];
                        generateEntry(entry);
                    }
                }
            },
            oneditsave: function () {
                // Convert a string containing a slash/delimited/path to an Array of (string) parts, removing any empty components
                // Return value may be zero-length
                var stringToParts = function (str) {
                    if (typeof str === "string") {
                        return str.split('/').filter(function (part) {
                            return part !== "";
                        });
                    } else {
                        return [];
                    }
                };

                var entries = $("#node-config-list-container").children();
                var node = this;
                node.devices = [];
                entries.each(function (i) {
                    var entry = $(this);
                    var row = {};
                    row.device = stringToParts(entry.find(".node-config-device-input-value").val());
                    row.payload = entry.find(".node-config-payload-input-value").val();
                    row.rawData = "0x" + parseInt(entry.find(".node-config-rawdata-input-value").val()).toString(16);
                    row.pulseWidth = Number(entry.find(".node-config-pulsewidth-input-value").val());
                    node.devices.push(row);
                });

                var compareEntries = function (a, b) {
                    var idx, result;
                    for (idx = 0; idx < Math.min(a.device.length, b.device.length); idx++) {
                        if (a.device[idx] < b.device[idx]) {
                            return -1;
                        } else if (a.device[idx] > b.device[idx]) {
                            return 1;
                        }
                    }
                    if (a.device.length < b.device.length) {
                        return -1;
                    } else if (a.device.length > b.device.length) {
                        return 1;
                    } else if (a.payload < b.payload) {
                        return -1;
                    } else if (a.payload > b.payload) {
                        return 1;
                    } else {
                        return 0;
                    }
                };

                node.devices = node.devices.sort(compareEntries).filter(function (item, idx, entry) {
                    if (idx > 0) {
                        return compareEntries(item, entry[idx-1]) !== 0;
                    } else {
                        return true;
                    }
                });
            }
        });
    </script>

<!-- This is a receiver node for listening to messages from PT2262 devices -->
<script type="text/x-red" data-template-name="rfx-PT2262-in">
    <div class="form-row node-input-port">
        <label for="node-input-port"><i class="fa fa-usb"></i> Serial Port</label>
        <input type="text" id="node-input-port">
    </div>
    <div class="form-row node-input-topic">
        <label for="node-input-topicSource"><i class="fa fa-envelope-o"></i> Address</label>
        <select id="node-input-topicSource" style="width:73% !important">
          <option value="all">listen for messages from any address</option>
          <option value="single">only listen for addresses matching a pattern</option>
        </select>
    </div>
    <div class="form-row" id="node-input-row-topic">
        <label for="node-input-topic"></label>
        <input type="text" id="node-input-topic" placeholder="PT2262/address">
    </div>
    <div class="form-row node-input-deviceList">
        <label for="node-input-deviceList"><i class="fa fa-list"></i> Devices</label>
        <input type="text" id="node-input-deviceList">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<!-- Help text for rfx-PT2262-in -->
<script type="text/x-red" data-help-name="rfx-PT2262-in">
<p>
Listens for messages from PT2262 devices using an RFXtrx433 transceiver
<p>
Translates the received raw data to a message topic (corresponding to a device address) and payload as specified by a
matching entry the configured list of Devices. If no matching entry is found, the received data & pulse width are
provided in the 'raw' property of the message; if multiple matches are found, the first in the list will be used to set
the topic & payload. The message also has a 'status' property indicating the received the signal strength (rssi).
<p>
When creating a device list, the address (topic) and payload may be assigned arbitrarily, but the combination of the two
must be unique. All addresses must start with 'PT2262/'. The same list may be shared by multiple rfx-PT2262-in and
rfx-PT2262-out nodes, or different nodes may use different lists.
<p>
The node can either receive all messages, or only those from a restricted subset of adresses which match a topic
template. This takes place using the topic found in the device list as the message address. For example, if data
0x555533 corresponds to topic 'PT2262/Remote/1 & payload '2', a message will be output if the address pattern is
'PT2262', 'PT2262/Remote' or 'PT2262/Remote/1'.
<p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('rfx-PT2262-in', {
        category: 'home automation',
        defaults: {
            name: { name:"" },
            port: { type:"rfxtrx-port", required:true },
            deviceList: { type:'PT2262-device-list', required:true },
            topicSource: { value:"all", required:true },
            topic: { value:"", validate:function (t) {
                    return this.topicSource == "all" || t.indexOf("PT2262/") === 0
                }
            }
        },
        color:"BurlyWood",
        inputs:0,
        outputs:1,
        icon: "rfxcom.png",
        label: function () {
            var rfxtrxNode = RED.nodes.node(this.rfxtrx);
            return this.name || (rfxtrxNode ? rfxtrxNode.label() : "rfx-PT2262");
        },
        labelStyle: function () {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function () {
            var topicSource = $("#node-input-topicSource");
            topicSource.change(function () {
                var id = topicSource.find("option:selected").val();
                if (id == "single") {
                    $("#node-input-row-topic").show();
                } else {
                    $("#node-input-row-topic").hide();
                }
            });
            topicSource.val(this.topicSource);
            topicSource.change();
        }
    });
</script>

<!-- This is a transmitter node for devices using the PT2262/PT2272 chipset -->
<script type="text/x-red" data-template-name="rfx-PT2262-out">
    <div class="form-row node-input-port">
        <label for="node-input-port"><i class="fa fa-usb"></i> Serial Port</label>
        <input type="text" id="node-input-port">
    </div>
    <div class="form-row node-input-topic">
        <label for="node-input-topicSource"><i class="fa fa-envelope-o"></i> Address</label>
        <select id="node-input-topicSource" style="width:73% !important">
          <option value="msg">get address from message topic</option>
          <option value="node">send all commands to the same address</option>
        </select>
    </div>
    <div class="form-row" id="node-input-row-topic">
        <label for="node-input-topic"></label>
        <input type="text" id="node-input-topic" placeholder="PT2262/address">
    </div>
    <div class="form-row node-input-deviceList">
        <label for="node-input-deviceList"><i class="fa fa-list"></i> Devices</label>
        <input type="text" id="node-input-deviceList">
    </div>
    <div class="form-row node-input-retransmit">
        <label for="node-input-retransmit"><i class="fa fa-refresh"></i> Repeat</label>
        <select id="node-input-retransmit" style="width:73% !important">
          <option value="none">send each command once only</option>
          <option value="once">repeat each command after a delay</option>
          <option value="repeat">repeat each command at regular intervals</option>
        </select>
    </div>
    <div class="form-row" id="node-input-row-retransmitInterval">
        <label for="node-input-retransmitInterval"></label>
        <span id="node-input-retransmitInterval-caption" style="width:10%; display:inline-block; margin-left: 8px; margin-right:12px;">Delay</span>
        <input type="text" id="node-input-retransmitInterval" style="width:10%" placeholder="10">
        <span id="node-input-retransmitInterval-units" style="display:inline-block; margin-left:6px;">seconds</span>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<!-- Help text for rfx-PT2262-out -->
<script type="text/x-red" data-help-name="rfx-PT2262-out">
<p>
Sends messages to PT2262/PT2272 devices using an RFXtrx433 transceiver
<p>
Translates the message topic ('address') and payload to the required raw data by looking for a matching entry in the
configured list of Devices. Alternatively, the same device address can be used for all messages. If no matching entry is
found, nothing is sent. If both topic and message payload are undefined, the value from the 'raw.data' property of
the message, if present, will be sent. A 'raw.pulseWidth' property can also be used to set the transmitted pulse width
in this case.
<p>
When creating a device list, the address (topic) and payload may be assigned arbitrarily, but the combination of the two
must be unique. All addresses must start with 'PT2262/'. The same list may be shared by multiple rfx-PT2262-in and
rfx-PT2262-out nodes, or different nodes may use different lists.
<p>
<p>
To improve reliability, each message may be retransmitted, either once or at regular intervals. Only the most
recent message to each specific device address is repeated: the next message sent there will cancel any pending repeats.
</p>
Supported device types are:
<ul>
<li>PT2262</li>
</ul>
</script>

<script type="text/javascript">
    RED.nodes.registerType('rfx-PT2262-out', {
        category: 'home automation',
        defaults: {
            name: {name:""},
            port: {type:"rfxtrx-port", required:true},
            deviceList: {type:'PT2262-device-list', required:true},
            topicSource: {value:"msg", required:true},
            retransmit: {value: "none"},
            retransmitInterval: {value: 20,
                validate:function (i) {return i >= 10}
            },
            topic: {value:"", validate:function (t) {
                    return this.topicSource == "msg" || t.indexOf("PT2262/") === 0
                }
            }
        },
        color:"BurlyWood",
        inputs:1,
        outputs:0,
        icon: "rfxcom.png",
        align: "right",
        label: function() {
            var rfxtrxNode = RED.nodes.node(this.rfxtrx);
            return this.name || (rfxtrxNode ? rfxtrxNode.label() : "rfx-PT2262");
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            var topicSource = $("#node-input-topicSource"),
                retransmit = $("#node-input-retransmit");
            retransmit.change(function () {
                var mode = retransmit.find("option:selected").val();
                if (mode === "none") {
                    $("#node-input-row-retransmitInterval").hide();
                } else {
                    if (mode === "once") {
                        $("#node-input-retransmitInterval-caption").text("Delay");
                        $("#node-input-retransmitInterval-units").text("seconds");
                    } else {
                        $("#node-input-retransmitInterval-caption").text("Interval");
                        $("#node-input-retransmitInterval-units").text("minutes");
                    }
                    $("#node-input-row-retransmitInterval").show();
                }
            });
            retransmit.val(this.retransmit);
            retransmit.change();
            topicSource.change(function() {
                var id = topicSource.find("option:selected").val();
                if (id == "node") {
                    $("#node-input-row-topic").show();
                } else {
                    $("#node-input-row-topic").hide();
                }
            });
            topicSource.val(this.topicSource);
            topicSource.change();
        }
    });
</script>

<!-- This is a transmitter node for 'raw' RFXCOM devices -->
<script type="text/x-red" data-template-name="rfx-raw-out">
    <div class="form-row node-input-port">
        <label for="node-input-port"><i class="fa fa-usb"></i> Serial Port</label>
        <input type="text" id="node-input-port">
    </div>
    <div class="form-row node-input-topic">
        <label for="node-input-topicSource"><i class="fa fa-envelope-o"></i> Address</label>
        <select id="node-input-topicSource" style="width:73% !important">
          <option value="msg">get address from message topic</option>
          <option value="node">send all commands to the same address</option>
        </select>
    </div>
    <div class="form-row" id="node-input-row-topic">
        <label for="node-input-topic"></label>
        <input type="text" id="node-input-topic" placeholder="RAW/address">
    </div>
    <div class="form-row node-input-deviceList">
        <label for="node-input-deviceList"><i class="fa fa-list"></i> Devices</label>
        <input type="text" id="node-input-deviceList">
    </div>
    <div class="form-row node-input-retransmit">
        <label for="node-input-retransmit"><i class="fa fa-refresh"></i> Repeat</label>
        <select id="node-input-retransmit" style="width:73% !important">
          <option value="none">send each command once only</option>
          <option value="once">repeat each command after a delay</option>
          <option value="repeat">repeat each command at regular intervals</option>
        </select>
    </div>
    <div class="form-row" id="node-input-row-retransmitInterval">
        <label for="node-input-retransmitInterval"></label>
        <span id="node-input-retransmitInterval-caption" style="width:10%; display:inline-block; margin-left: 8px; margin-right:12px;">Delay</span>
        <input type="text" id="node-input-retransmitInterval" style="width:10%" placeholder="10">
        <span id="node-input-retransmitInterval-units" style="display:inline-block; margin-left:6px;">seconds</span>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<!-- Help text for rfx-raw-out -->
<script type="text/x-red" data-help-name="rfx-raw-out">
    <p>
    Sends 'raw' format messages using an RFXtrx433 transceiver
    <p>
    Translates the message topic ('address') and payload to the required seqence of pulse times by looking for a matching entry in the
    configured list of Devices. Alternatively, the same device address can be used for all messages. If no matching entry is
    found, nothing is sent. If both topic and message payload are undefined, the pulse sequence specified by the 'raw.pulseTimes' property of
    the message, if present, will be sent. A 'raw.repeats' property can optionally be used to set the number of repeats of the pulse
    sequence in each transmission: if raw.repeats is not specified, the pulse sequence is repeated 5 times.
    <p>
    When editing the Device list, click the edit (pencil) button to enter the pulse times as a list of integers (in the range 1 to 65535). Alternate numbers
    are the carrier on &amp; off times in microseconds. Numbers can be separated by commas, spaces, tabs, or newlines. The format generated
    by RFXmgr is compatible and can be copied & pasted into the editor. There is no need to split the pulse times into multiple messages,
    the node will do this automatically using the entered data.
    <p>
    When creating a device list, the address (topic) and payload may be assigned arbitrarily, but the combination of the two
    must be unique. All addresses must start with 'RAW/'. The same list may be shared by multiple rfx-raw-out nodes,
    or different nodes may use different lists.
    <p>
    <p>
    To improve reliability, each message may be retransmitted, either once or at regular intervals. Only the most
    recent message to each specific device address is retransmitted: the next message sent there will cancel any pending retransmissions.
    </p>
    Supported device types are:
    <ul>
    <li>RAW</li>
    </ul>
    </script>
    
<script type="text/javascript">
    RED.nodes.registerType('rfx-raw-out', {
        category: 'home automation',
        defaults: {
            name: {name:""},
            port: {type:"rfxtrx-port", required:true},
            deviceList: {type:'raw-device-list', required:true},
            topicSource: {value:"msg", required:true},
            retransmit: {value: "none"},
            retransmitInterval: {value: 20,
                validate:function (i) {return i >= 10}
            },
            topic: {value:"", validate:function (t) {
                    return this.topicSource == "msg" || t.indexOf("RAW/") === 0
                }
            }
        },
        color:"BurlyWood",
        inputs:1,
        outputs:0,
        icon: "rfxcom.png",
        align: "right",
        label: function() {
            var rfxtrxNode = RED.nodes.node(this.rfxtrx);
            return this.name || (rfxtrxNode ? rfxtrxNode.label() : "rfx-raw");
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            var topicSource = $("#node-input-topicSource"),
                retransmit = $("#node-input-retransmit");
            retransmit.change(function () {
                var mode = retransmit.find("option:selected").val();
                if (mode === "none") {
                    $("#node-input-row-retransmitInterval").hide();
                } else {
                    if (mode === "once") {
                        $("#node-input-retransmitInterval-caption").text("Delay");
                        $("#node-input-retransmitInterval-units").text("seconds");
                    } else {
                        $("#node-input-retransmitInterval-caption").text("Interval");
                        $("#node-input-retransmitInterval-units").text("minutes");
                    }
                    $("#node-input-row-retransmitInterval").show();
                }
            });
            retransmit.val(this.retransmit);
            retransmit.change();
            topicSource.change(function() {
                var id = topicSource.find("option:selected").val();
                if (id == "node") {
                    $("#node-input-row-topic").show();
                } else {
                    $("#node-input-row-topic").hide();
                }
            });
            topicSource.val(this.topicSource);
            topicSource.change();
        }
    });
</script>

<!-- This is the config node holding deviceList data for Raw nodes -->
<script type="text/x-red" data-template-name="raw-device-list">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <div style="padding: 5px; padding-left: 0px; border: 1px solid #fff; margin-bottom:-12px">
            <span style="display:inline-block; margin-left:2px; width:39%;">Topic</span>
            <span style="display:inline-block; margin-left:6px; width:19%;">Payload</span>
            <span style="display:inline-block; margin-left:6px; width:16%; text-align:left;">Pulse Data</span>
            <span style="display:inline-block; margin-left:2px; width:8%; text-align:right;">Repeats</span>
        </div>
    </div>
    <div class="form-row">
        <div id="node-config-list-container-div" style="border-radius: 5px; height: 320px; padding: 5px; padding-left: 0px; border: 1px solid #ccc; overflow-y:scroll;">
            <ol id="node-config-list-container" style="list-style-type:none; margin: 0;">
            </ol>
        </div>
    </div>
    <div class="form-row">
        <div id="editor-div" style="border-radius: 5px; height: 268px; padding: 5px; padding-left: 0px; border: 1px solid #ccc; overflow-y:scroll;">
            <div id="node-config-edit-pulses" class="node-text-editor" style="height:216px; min-height:132px;">
            </div>
            <div id="edit-buttons-row" align="right">
                <button id="edit-cancel-button" class="red-ui-button" style="margin:5px;">Cancel</button>
                <button id="edit-ok-button" class="red-ui-button" style="margin:5px;">OK</button>
            </div>
        </div>
    </div>
    <div class="form-row">
        <button class="red-ui-button" id="node-config-add-list-entry" style="margin-top: 4px;"><i class="fa fa-plus"></i> Add New Device</button>
    </div>

</script>

<script type="text/javascript">
    RED.nodes.registerType('raw-device-list', {
        category: 'config',
        defaults: {
            name: { value:"", required:true },
            devices: { value:[], required: true }
        },
        label: function () {
            return this.name || 'Raw devices';
        },
        oneditprepare: function () {
            var node = this;
            function generateEntry(entry, insert) {
                var container = $('<li/>', {style:"margin:0; padding:4px; padding-left:2px; padding-top:2px;"});
                var row = $('<div/>').appendTo(container);
                var entryField = $('<span/>').appendTo(row);
                var deviceField = $('<input/>', { class:"node-config-device-input-value", type:"text",
                    style:"margin-left:2px; margin-right:2px; width:40%;"}).appendTo(entryField);
                var payloadField = $('<input/>', { class:"node-config-payload-input-value", type:"text",
                    style:"margin-left:2px; margin-right:2px; width:20%;"}).appendTo(entryField);
                var pulseTimesField = $('<input/>', { class:"node-config-pulse-data-input-value", type:"text", disabled:true,
                    style:"margin-left:2px; margin-right:0px; width:15%; text-align:right;"}).appendTo(entryField);
                var editButton = $('<button>', {type:"button", class:"red-ui-button", style:"margin-left: 0px;"}).appendTo(entryField);
                    $('<i/>', {class:"fa fa-pencil"}).appendTo(editButton);
                    editButton.click(function(row) {
                        node.rowBeingEdited = $(this).parent();
                        node.showEditor(true);
                        node.editor.setValue($(this).siblings('.node-config-pulse-data-input-value').val());
                        node.editor.setOptions({useWrapMode: true});
                    });
                var repeatsField = $('<input/>', {class:"node-config-repeats-input-value", type:"text",
                    style:"margin-left:2px; margin-right:2px; width:8%; text-align:right;"}).appendTo(entryField);
                var deleteButton = $('<button>', {type:"button", id:"delete-button", class:"red-ui-button", style:"margin-left: 5px;"}).appendTo(row);
                    $('<i/>', {class:"fa fa-trash"}).appendTo(deleteButton);
                    deleteButton.click(function() {
                        container.css({"background":"#fee"});
                        container.fadeOut(300, function() {
                            $(this).remove();
                        });
                    });
                    deviceField.val(entry.device.join("/"));
                    payloadField.val(entry.payload);
                    pulseTimesField.val(entry.pulseTimes.toString());
                    repeatsField.val(entry.repeats);
                    $("#node-config-list-container").append(container);
            };

            $("#node-config-add-list-entry").click(function () {
                generateEntry({ device:["RAW"], payload:"", pulseTimes:[], repeats:5 });
                $("#node-config-list-container-div").scrollTop($("#node-config-list-container-div").get(0).scrollHeight);
            });

            node.showEditor = function (makeVisible) {
                if (node.rowBeingEdited != null) {
                    if (makeVisible) {
                        node.rowBeingEdited.parent().parent().siblings().hide();
                        node.rowBeingEdited.children().attr("disabled", true);
                        node.rowBeingEdited.parent().children('#delete-button').attr("disabled", true);
                        $('#editor-div').show().appendTo(node.rowBeingEdited.parent().parent()).attr("disabled", false);
                    } else {
                        node.rowBeingEdited.parent().parent().siblings().show();
                        node.rowBeingEdited.children().attr("disabled", false);
                        node.rowBeingEdited.children('.node-config-pulse-data-input-value').attr("disabled", true);
                        node.rowBeingEdited.parent().children('#delete-button').attr("disabled", false);
                        $('#editor-div').hide().appendTo('#node-config-list-container-div');
                        node.rowBeingEdited = null;
                    }
                }
            }
            $("#edit-cancel-button").click(function () { node.showEditor(false) });
            $("#edit-ok-button").click(function () {
                if (node.rowBeingEdited != null) {
                    let str = node.editor.getValue().trim();
                    if (str.search(/[^0-9 ,\t\r\n]/) != -1) {
                        alert("Pulse times must be entered as positive decimal integers");
                    } else {
                        let arr = str.split(/[ ,\t\r\n]+/).map(function(s) {return parseInt(s)});
                        if (arr.some(function(x) {return isNaN(x)})) {
                            alert("All pulse time data must be numeric");
                        } else if (arr.length > 496 || arr.length < 2) {
                            alert("Number of pulse times must be in the range 2 to 496");
                        } else if (arr.length % 2 != 0) {
                            alert("Number of pulse times must be even");
                        } else if (arr.some(function(x) {return x <= 0 || x >= 65536})) {
                            alert("Pulse times must be in the range 1 to 65535");
                        } else {
                            node.rowBeingEdited.children('.node-config-pulse-data-input-value').val(node.editor.getValue());
                            node.showEditor(false);
                        }
                    }
                }
            });
            if ( this.devices !== undefined ) {
                for (var i = 0; i < this.devices.length; i++) {
                    var entry = this.devices[i];
                    generateEntry(entry);
                }
            }
            node.rowBeingEdited = null;
            node.editor = RED.editor.createEditor({
                        id: 'node-config-edit-pulses',
                        mode: 'ace/mode/text',
                        value: ""
                        });
            node.editor.updateOptions({wordWrap: "on", lineNumbers: false, minimap: {enabled: false}});
            $('#editor-div').hide();

        },
        oneditsave: function () {
                // Convert a string containing a slash/delimited/path to an Array of (string) parts, removing any empty components
                // Return value may be zero-length
                var stringToParts = function (str) {
                    if (typeof str === "string") {
                        return str.split('/').filter(function (part) {
                            return part !== "";
                        });
                    } else {
                        return [];
                    }
                };

                var entries = $("#node-config-list-container").children();
                var node = this;
                // If the pulse times editor is open, behave as if the OK button has been clicked
                if (node.rowBeingEdited != null) {
                    node.rowBeingEdited.children('.node-config-pulse-data-input-value').val(node.editor.getValue());
                }
                node.devices = [];
                entries.each(function (i) {
                    var entry = $(this);
                    var row = {};
                    row.device = stringToParts(entry.find(".node-config-device-input-value").val());
                    row.payload = entry.find(".node-config-payload-input-value").val();
                    row.pulseTimes = entry.find(".node-config-pulse-data-input-value").val();
                    row.repeats = Number(entry.find(".node-config-repeats-input-value").val());
                    node.devices.push(row);
                });

                var compareEntries = function (a, b) {
                    var idx, result;
                    for (idx = 0; idx < Math.min(a.device.length, b.device.length); idx++) {
                        if (a.device[idx] < b.device[idx]) {
                            return -1;
                        } else if (a.device[idx] > b.device[idx]) {
                            return 1;
                        }
                    }
                    if (a.device.length < b.device.length) {
                        return -1;
                    } else if (a.device.length > b.device.length) {
                        return 1;
                    } else if (a.payload < b.payload) {
                        return -1;
                    } else if (a.payload > b.payload) {
                        return 1;
                    } else {
                        return 0;
                    }
                };

                node.devices = node.devices.sort(compareEntries).filter(function (item, idx, entry) {
                    if (idx > 0) {
                        return compareEntries(item, entry[idx-1]) !== 0;
                    } else {
                        return true;
                    }
                });
                node.editor.destroy();
                delete node.editor;
            }
        });
    </script>

